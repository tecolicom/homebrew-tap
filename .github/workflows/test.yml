name: Test Formulas

on:
  push:
    paths:
      - 'Formula/*.rb'
      - '.github/workflows/*.yml'
  schedule:
    # Weekly: Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  test:
    runs-on: ${{ matrix.runs-on }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs-on: macos-latest
          - runs-on: ubuntu-latest
          - runs-on: ubuntu-latest
            container: homebrew/brew
    steps:
      - uses: actions/checkout@v4
        if: ${{ !matrix.container }}
      - uses: Homebrew/actions/setup-homebrew@master
        if: ${{ !matrix.container }}
      - name: Set up Homebrew tap
        if: ${{ matrix.container }}
        run: brew tap tecolicom/tap

      - name: Install all formulas
        shell: bash
        run: |
          failed=()
          for rb in Formula/*.rb; do
            name="${rb%.rb}"
            name="${name#Formula/}"
            echo "::group::$name"
            if brew install "tecolicom/tap/$name"; then
              echo "✓ $name passed"
            else
              echo "✗ $name failed"
              failed+=("$name")
            fi
            echo "::endgroup::"
          done
          if [ ${#failed[@]} -ne 0 ]; then
            echo "::error::Failed formulas: ${failed[*]}"
            exit 1
          fi
