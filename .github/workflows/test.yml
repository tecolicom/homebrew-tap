name: Test Formulas

on:
  push:
    paths:
      - 'Formula/*.rb'
      - '.github/workflows/*.yml'
  schedule:
    # Weekly: Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: Homebrew/actions/setup-homebrew@master

      - name: Install all formulas
        run: |
          # Order matters: dependencies must be installed before dependents
          formulas=(
            getoptlong-bash
            app-greple
            app-optex
            app-ansi-tools
            app-sdif
            app-cat-v
            app-chot
            app-greple-charcode
            app-greple-jq
            app-greple-msdoc
            app-greple-pw
            app-greple-subst-desumasu
            app-greple-wordle
            app-greple-xlate
            app-optex-glob
            app-optex-mask
            app-optex-pingu
            app-optex-rpn
            app-optex-scroll
            app-optex-textconv
            app-optex-up
            app-optex-xform
            app-dozo
            app-nup
            app-mdee
          )
          failed=()
          for name in "${formulas[@]}"; do
            echo "::group::$name"
            if brew install --build-from-source "tecolicom/tap/$name"; then
              echo "✓ $name passed"
            else
              echo "✗ $name failed"
              failed+=("$name")
            fi
            echo "::endgroup::"
          done
          if [ ${#failed[@]} -ne 0 ]; then
            echo "::error::Failed formulas: ${failed[*]}"
            exit 1
          fi

  test-docker:
    runs-on: ubuntu-latest
    container: homebrew/brew
    steps:
      - name: Install all formulas
        shell: bash
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        run: |
          brew tap tecolicom/tap
          formulas=(
            getoptlong-bash
            app-greple
            app-optex
            app-ansi-tools
            app-sdif
            app-cat-v
            app-chot
            app-greple-charcode
            app-greple-jq
            app-greple-msdoc
            app-greple-pw
            app-greple-subst-desumasu
            app-greple-wordle
            app-greple-xlate
            app-optex-glob
            app-optex-mask
            app-optex-pingu
            app-optex-rpn
            app-optex-scroll
            app-optex-textconv
            app-optex-up
            app-optex-xform
            app-dozo
            app-nup
            app-mdee
          )
          failed=()
          for name in "${formulas[@]}"; do
            echo "::group::$name"
            if brew install --build-from-source "tecolicom/tap/$name"; then
              echo "✓ $name passed"
            else
              echo "✗ $name failed"
              failed+=("$name")
            fi
            echo "::endgroup::"
          done
          if [ ${#failed[@]} -ne 0 ]; then
            echo "::error::Failed formulas: ${failed[*]}"
            exit 1
          fi
