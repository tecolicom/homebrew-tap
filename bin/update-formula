#!/bin/bash
# Update Homebrew formula from CPAN
# Usage: bin/update-formula <formula-name> ...
#        bin/update-formula --all
# Example: bin/update-formula app-greple app-mdee
#          bin/update-formula --all

set -e

cd "$(dirname "$0")/.."

# Fetch latest CPAN release info and update URL/SHA256 in formula file.
# Uses dist name in URL as unique identifier for targeted replacement.
# Returns 0 if updated, 1 if already up to date or error.
update_cpan_dist() {
    local formula_file=$1
    local dist_name=$2

    local info url version
    info=$(curl -s "https://fastapi.metacpan.org/v1/release/$dist_name")
    version=$(echo "$info" | jq -r '.version')
    url=$(echo "$info" | jq -r '.download_url')

    if [[ "$version" == "null" || "$url" == "null" ]]; then
        echo "  Error: Could not fetch info for $dist_name"
        return 1
    fi

    # Get current version from URL containing this dist name
    local current_version
    current_version=$(grep "${dist_name}-" "$formula_file" | sed -E "s|.*${dist_name}-([0-9v.]+)\.tar\.gz.*|\1|")

    if [[ "$current_version" == "$version" ]]; then
        echo "  $dist_name: up to date ($version)"
        return 1
    fi

    echo "  $dist_name: $current_version -> $version"

    local sha256
    sha256=$(curl -sL "$url" | shasum -a 256 | cut -d' ' -f1)

    # Find the specific URL line for this dist and update it + next sha256 line
    local url_line sha_line
    url_line=$(grep -n "${dist_name}-" "$formula_file" | head -1 | cut -d: -f1)
    sha_line=$((url_line + 1))

    sed -i '' "${url_line}s|url \".*\"|url \"${url}\"|" "$formula_file"
    sed -i '' "${sha_line}s|sha256 \".*\"|sha256 \"${sha256}\"|" "$formula_file"

    return 0
}

# Extract resource dist names from formula
extract_resources() {
    local formula_file=$1
    grep -oE 'resource "([^"]+)"' "$formula_file" | sed 's/resource "//;s/"//' || true
}

# Remove revision line from formula
remove_revision() {
    local formula_file=$1
    sed -i '' '/^  revision [0-9]/d' "$formula_file"
}

# Bump revision in formula (add or increment)
bump_revision() {
    local formula_file=$1
    local current
    current=$(grep -oE 'revision [0-9]+' "$formula_file" | awk '{print $2}' || true)

    if [[ -z "$current" ]]; then
        # Add revision 1 after primary sha256 line
        local sha_line
        sha_line=$(grep -n '^\s*sha256' "$formula_file" | head -1 | cut -d: -f1)
        sed -i '' "${sha_line}a\\
  revision 1" "$formula_file"
    else
        local new=$((current + 1))
        sed -i '' "s/revision $current/revision $new/" "$formula_file"
    fi
}

update_formula() {
    local FORMULA=$1
    local FORMULA_FILE="Formula/${FORMULA}.rb"

    if [[ ! -f "$FORMULA_FILE" ]]; then
        echo "Error: $FORMULA_FILE not found"
        return 1
    fi

    # Extract primary CPAN dist name from first URL line
    local CPAN_DIST
    CPAN_DIST=$(grep -E '^\s*url\s+"' "$FORMULA_FILE" | head -1 | sed -E 's|.*/([^/]+)-[0-9v.]+\.tar\.gz.*|\1|')

    if [[ -z "$CPAN_DIST" ]]; then
        echo "Skipping $FORMULA (no CPAN URL found)"
        return 0
    fi

    echo "=== $FORMULA (CPAN: $CPAN_DIST) ==="

    local primary_changed=false
    local resource_changed=false

    # Update primary dist
    if update_cpan_dist "$FORMULA_FILE" "$CPAN_DIST"; then
        primary_changed=true
    fi

    # Update resources
    local resources
    resources=$(extract_resources "$FORMULA_FILE")
    if [[ -n "$resources" ]]; then
        while IFS= read -r res; do
            if update_cpan_dist "$FORMULA_FILE" "$res"; then
                resource_changed=true
            fi
        done <<< "$resources"
    fi

    # Revision logic
    if $primary_changed; then
        # Primary version changed: remove revision (version bump resets it)
        remove_revision "$FORMULA_FILE"
        echo "  -> Version bumped (revision reset)"
    elif $resource_changed; then
        # Only resources changed: bump revision
        bump_revision "$FORMULA_FILE"
        echo "  -> Resources updated (revision bumped)"
    fi

    echo ""
}

# Main
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <formula-name> ..."
    echo "       $0 --all"
    exit 1
fi

if [[ "$1" == "--all" ]]; then
    for f in Formula/*.rb; do
        formula=$(basename "$f" .rb)
        update_formula "$formula" || true
    done
else
    for formula in "$@"; do
        update_formula "$formula"
    done
fi

echo "Done. To commit changes:"
echo "  git add Formula/"
echo "  git commit -m 'Update formulas'"
echo "  git push"
